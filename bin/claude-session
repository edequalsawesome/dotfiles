#!/bin/bash

# claude-session - Interactive tmux session manager for Claude Code
#
# Usage:
#   claude-session                    # Interactive menu
#   claude-session <name>             # Create/attach to session
#   claude-session <name> "<cmd>"     # Create session and run command
#
# Examples:
#   claude-session agent
#   claude-session agent "claude --dangerously-skip-permissions"

GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

# If an argument is passed, go directly to that session
if [[ -n "$1" ]]; then
    SESSION_NAME="$1"
    INITIAL_CMD="$2"

    if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
        echo -e "${GREEN}Attaching to existing session: $SESSION_NAME${NC}"
        tmux attach -t "$SESSION_NAME"
    else
        echo -e "${BLUE}Creating new session: $SESSION_NAME${NC}"
        if [[ -n "$INITIAL_CMD" ]]; then
            tmux new-session -s "$SESSION_NAME" "$INITIAL_CMD"
        else
            tmux new-session -s "$SESSION_NAME"
        fi
    fi
    exit 0
fi

# No argument - show interactive menu
echo ""
echo -e "${YELLOW}=======================================${NC}"
echo -e "${YELLOW}       Claude Code Session Manager${NC}"
echo -e "${YELLOW}=======================================${NC}"
echo ""

# Get existing sessions
SESSIONS=$(tmux list-sessions -F "#{session_name}" 2>/dev/null)

if [[ -n "$SESSIONS" ]]; then
    echo -e "${GREEN}Active sessions:${NC}"
    echo ""
    i=1
    declare -a SESSION_ARRAY
    while IFS= read -r session; do
        WINDOWS=$(tmux list-windows -t "$session" 2>/dev/null | wc -l | tr -d ' ')
        ATTACHED=$(tmux list-sessions -F "#{session_name}:#{session_attached}" | grep "^$session:" | cut -d: -f2)
        if [[ "$ATTACHED" == "1" ]]; then
            STATUS="(attached)"
        else
            STATUS=""
        fi
        echo -e "  ${BLUE}[$i]${NC} $session - $WINDOWS window(s) $STATUS"
        SESSION_ARRAY[$i]="$session"
        ((i++))
    done <<< "$SESSIONS"
    echo ""
    echo -e "  ${BLUE}[n]${NC} Create NEW session"
    echo -e "  ${BLUE}[q]${NC} Quit"
    echo ""
else
    echo -e "${YELLOW}No active sessions found.${NC}"
    echo ""
    echo -e "  ${BLUE}[n]${NC} Create NEW session"
    echo -e "  ${BLUE}[q]${NC} Quit"
    echo ""
fi

# Get user choice
echo -n "Choose [1-$((i-1))/n/q]: "
read -r CHOICE

case "$CHOICE" in
    q|Q)
        echo "Bye!"
        exit 0
        ;;
    n|N)
        echo -n "New session name: "
        read -r NEW_NAME
        if [[ -z "$NEW_NAME" ]]; then
            NEW_NAME="claude-$(date +%H%M)"
        fi
        echo -e "${BLUE}Creating: $NEW_NAME${NC}"
        tmux new-session -s "$NEW_NAME"
        ;;
    [0-9]*)
        if [[ -n "${SESSION_ARRAY[$CHOICE]}" ]]; then
            echo -e "${GREEN}Attaching to: ${SESSION_ARRAY[$CHOICE]}${NC}"
            tmux attach -t "${SESSION_ARRAY[$CHOICE]}"
        else
            echo "Invalid choice"
            exit 1
        fi
        ;;
    *)
        echo "Invalid choice"
        exit 1
        ;;
esac
